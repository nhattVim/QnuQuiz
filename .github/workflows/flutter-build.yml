name: Flutter Debug Build & Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

defaults:
    run:
        working-directory: frontend

jobs:
    # ============================================================
    # BUILD ANDROID + IOS (main.dart)
    # ============================================================
    build-mobile:
        runs-on: macos-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6.0.0

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Install dependencies
              run: flutter pub get

            - name: Clean Build
              run: flutter clean

            - name: Build Android debug APK (main.dart)
              run: flutter build apk --debug -t lib/main.dart

            - name: Build iOS debug app (simulator)
              run: flutter build ios --debug --no-codesign -t lib/main.dart

            - name: Zip iOS app
              run: |
                  APP_PATH=$(find build/ios -name "Runner.app" -type d | head -n 1)
                  zip -r Runner.app.zip "$APP_PATH"
                  mv Runner.app.zip "$GITHUB_WORKSPACE/frontend/ios-simulator-build.zip"

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: mobile-build
                  path: |
                      frontend/build/app/outputs/flutter-apk/app-debug.apk
                      frontend/ios-simulator-build.zip

    # ============================================================
    # BUILD WINDOWS (main_admin.dart)
    # ============================================================
    build-windows:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Enable Windows
              run: flutter config --enable-windows-desktop

            - name: Install dependencies
              run: flutter pub get

            - name: Build Windows (main_admin.dart)
              run: flutter build windows -t lib/main_admin.dart

            - name: Create Inno Setup Script
              shell: powershell
              run: |
                  $script = @"
                  [Setup]
                  AppName=AdminApp
                  AppVersion=${{ github.ref_name }}
                  DefaultDirName={autopf}\QnuQuizApp
                  DefaultGroupName=QnuQuizApp
                  OutputBaseFilename=QnuQuiz_Admin_Installer
                  Compression=lzma
                  SolidCompression=yes
                  ArchitecturesInstallIn64BitMode=x64

                  [Files]
                  Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

                  [Icons]
                  Name: "{group}\QnuQuizApp"; Filename: "{app}\frontend.exe"
                  Name: "{commondesktop}\QnuQuizApp"; Filename: "{app}\frontend.exe"
                  "@
                  $script | Out-File -FilePath installer.iss -Encoding UTF8

            - name: Compile Windows Installer (.exe)
              run: iscc installer.iss

            - name: Upload Windows Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-installer
                  path: frontend/Output/QnuQuiz_Admin_Installer.exe

    # ============================================================
    # BUILD LINUX (main_admin.dart)
    # ============================================================
    build-linux:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install dependencies for Linux desktop
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev liblzma-dev clang cmake ninja-build pkg-config libayatana-appindicator3-dev

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Enable Linux
              run: flutter config --enable-linux-desktop

            - name: Install deps
              run: flutter pub get

            - name: Build Linux (main_admin.dart)
              run: flutter build linux -t lib/main_admin.dart

            - name: Compress Linux Build
              run: |
                  cd build/linux/x64/release/bundle
                  tar -czf ../../../../../linux-admin-app.tar.gz .

            - name: Upload Linux Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-build
                  path: frontend/linux-admin-app.tar.gz

    # ============================================================
    # CREATE RELEASE
    # ============================================================
    release:
        needs: [build-mobile, build-windows, build-linux]
        runs-on: ubuntu-latest

        steps:
            - uses: actions/download-artifact@v4
              with:
                  path: ./dist

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  name: Release ${{ github.ref_name }}
                  body: |
                      Builds generated from tag: ${{ github.ref_name }}

                      **Mobile:**
                      - Android APK (Debug)
                      - iOS Simulator Build (Zip)

                      **Desktop:**
                      - Windows: File cài đặt `.exe` (Setup)
                      - Linux: File nén `.tar.gz` (Giải nén và chạy file executable bên trong)
                  files: |
                      ./dist/mobile-build/*
                      ./dist/windows-installer/*
                      ./dist/linux-build/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
