name: Flutter Debug Build & Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

defaults:
    run:
        working-directory: frontend

jobs:
    # ============================================================
    # BUILD ANDROID
    # ============================================================
    build-android:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Install dependencies
              run: flutter pub get

            - name: Build Android APK
              run: flutter build apk --debug -t lib/main.dart

            - name: Move APK to root
              run: mv build/app/outputs/flutter-apk/app-debug.apk QnuQuiz.apk

            - name: Upload Android Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: android-build
                  path: frontend/QnuQuiz.apk

    # ============================================================
    # BUILD IOS
    # ============================================================
    build-ios:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Install dependencies
              run: flutter pub get

            - name: Build iOS (Simulator)
              run: flutter build ios --debug --no-codesign -t lib/main.dart

            - name: Zip iOS App
              run: |
                  APP_PATH=$(find build/ios -name "Runner.app" -type d | head -n 1)
                  zip -r QnuQuiz.zip "$APP_PATH"

            - name: Upload iOS Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ios-build
                  path: frontend/QnuQuiz.zip

    # ============================================================
    # BUILD WINDOWS
    # ============================================================
    build-windows:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Enable Windows
              run: flutter config --enable-windows-desktop

            - name: Install dependencies
              run: flutter pub get

            - name: Build Windows
              run: flutter build windows -t lib/main_admin.dart

            - name: Create Inno Setup Script
              shell: powershell
              run: |
                  $script = @"
                  [Setup]
                  AppName=QnuQuiz Admin
                  AppVersion=${{ github.ref_name }}
                  DefaultDirName={autopf}\QnuQuiz Admin
                  DefaultGroupName=QnuQuiz Admin
                  OutputBaseFilename=QnuQuiz_Admin
                  Compression=lzma
                  SolidCompression=yes
                  ArchitecturesInstallIn64BitMode=x64

                  [Files]
                  Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

                  [Icons]
                  Name: "{group}\QnuQuiz Admin"; Filename: "{app}\QnuQuizAdmin.exe"
                  Name: "{commondesktop}\QnuQuiz Admin"; Filename: "{app}\QnuQuizAdmin.exe"
                  "@
                  $script | Out-File -FilePath installer.iss -Encoding UTF8

            - name: Compile Windows Installer
              run: iscc installer.iss

            - name: Upload Windows Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-installer
                  path: frontend/Output/QnuQuiz_Admin.exe

    # ============================================================
    # BUILD LINUX
    # ============================================================
    build-linux:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Install System Dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev liblzma-dev clang cmake ninja-build pkg-config libayatana-appindicator3-dev libwebkit2gtk-4.1-dev libsecret-1-dev

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.7"

            - name: Enable Linux
              run: flutter config --enable-linux-desktop

            - name: Install dependencies
              run: flutter pub get

            - name: Build Linux
              run: flutter build linux -t lib/main_admin.dart

            - name: Compress Linux Build
              run: |
                  cd build/linux/x64/release/bundle
                  tar -czf ../../../../../QnuQuiz_Admin.tar.gz .

            - name: Upload Linux Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-build
                  path: frontend/QnuQuiz_Admin.tar.gz

    # ============================================================
    # CREATE RELEASE
    # ============================================================
    release:
        needs: [build-android, build-ios, build-windows, build-linux]
        runs-on: ubuntu-latest
        steps:
            - uses: actions/download-artifact@v4
              with:
                  path: ./dist

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  name: Release ${{ github.ref_name }}
                  body: |
                      Builds generated from tag: ${{ github.ref_name }}

                      **Mobile (User App):**
                      - Android: `QnuQuiz.apk`
                      - iOS: `QnuQuiz.zip`

                      **Desktop (Admin App):**
                      - Windows: `QnuQuiz_Admin.exe`
                      - Linux: `QnuQuiz_Admin.tar.gz`
                  files: |
                      ./dist/android-build/*
                      ./dist/ios-build/*
                      ./dist/windows-installer/*
                      ./dist/linux-build/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
